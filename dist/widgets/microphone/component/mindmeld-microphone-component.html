<template id="mindmeld-microphone">
    <!-- inject:css -->
    <style>@-webkit-keyframes mic-listening-pulse {
  0% {
    background-color: #2fbbfb; }

  50% {
    background-color: #0488c0; }

  100% {
    background-color: #2fbbfb; } }

@-moz-keyframes mic-listening-pulse {
  0% {
    background-color: #2fbbfb; }

  50% {
    background-color: #0488c0; }

  100% {
    background-color: #2fbbfb; } }

@-ms-keyframes mic-listening-pulse {
  0% {
    background-color: #2fbbfb; }

  50% {
    background-color: #0488c0; }

  100% {
    background-color: #2fbbfb; } }

@-o-keyframes mic-listening-pulse {
  0% {
    background-color: #2fbbfb; }

  50% {
    background-color: #0488c0; }

  100% {
    background-color: #2fbbfb; } }

@keyframes mic-listening-pulse {
  0% {
    background-color: #2fbbfb; }

  50% {
    background-color: #0488c0; }

  100% {
    background-color: #2fbbfb; } }

.mindmeld-microphone .icon-container {
  border-radius: 60px;
  background-color: #2fbbfb;
  width: 60px;
  height: 60px;
  -webkit-transition: background-color 0.5s ease-in-out, box-shadow 0.3s ease-out;
  -moz-transition: background-color 0.5s ease-in-out, box-shadow 0.3s ease-out;
  -ms-transition: background-color 0.5s ease-in-out, box-shadow 0.3s ease-out;
  -o-transition: background-color 0.5s ease-in-out, box-shadow 0.3s ease-out;
  transition: background-color 0.5s ease-in-out, box-shadow 0.3s ease-out;
  box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3) inset; }
  .mindmeld-microphone .icon-container .icon {
    width: 32px;
    height: 32px;
    fill: white;
    display: block;
    margin: 0 auto;
    position: relative;
    -webkit-transition: opacity 0.3s ease-out;
    -moz-transition: opacity 0.3s ease-out;
    -ms-transition: opacity 0.3s ease-out;
    -o-transition: opacity 0.3s ease-out;
    transition: opacity 0.3s ease-out; }
  .mindmeld-microphone .icon-container .mic-icon {
    opacity: 1;
    top: 25%; }
  .mindmeld-microphone .icon-container .mute-icon {
    opacity: 0;
    top: -28%; }
  .mindmeld-microphone .icon-container .lock-icon {
    opacity: 0;
    top: -85%; }
  .mindmeld-microphone .icon-container:hover {
    cursor: pointer;
    background-color: #0488c0; }
.mindmeld-microphone.listening .icon-container {
  box-shadow: 0 0 0 8px #333 inset;
  -webkit-animation: mic-listening-pulse 1.5s infinite;
  -moz-animation: mic-listening-pulse 1.5s infinite;
  -ms-animation: mic-listening-pulse 1.5s infinite;
  -o-animation: mic-listening-pulse 1.5s infinite;
  animation: mic-listening-pulse 1.5s infinite; }
.mindmeld-microphone.listening.lock .icon-container .mic-icon {
  opacity: 0; }
.mindmeld-microphone.listening.lock .icon-container .lock-icon {
  opacity: 1; }
.mindmeld-microphone.disabled .icon-container {
  background-color: #aaa; }
  .mindmeld-microphone.disabled .icon-container .mic-icon {
    opacity: 0; }
  .mindmeld-microphone.disabled .icon-container .mute-icon {
    opacity: 1; }
  .mindmeld-microphone.disabled .icon-container:hover {
    cursor: default; }
.mindmeld-microphone .volume-pulser {
  width: 60px;
  height: 60px;
  border-radius: 60px;
  background-color: rgba(0, 0, 0, 0.4);
  transform: scale(0.9);
  position: relative;
  bottom: 60px;
  z-index: -1;
  -webkit-transition: 0.15s ease-out;
  -moz-transition: 0.15s ease-out;
  -ms-transition: 0.15s ease-out;
  -o-transition: 0.15s ease-out;
  transition: 0.15s ease-out; }
</style>
    <!-- endinject -->
    <div class="mindmeld-microphone">
        <div class="icon-container">
            <svg class="mic-icon icon" x="0px" y="0px" viewbox="0 0 32 32">
                <path d="M16,21.625c2.682,0,4.875-2.25,4.875-5V6.375c0-2.75-2.193-5-4.875-5c-2.682,0-4.875,2.25-4.875,5v10.25  C11.125,19.375,13.318,21.625,16,21.625z M21.876,11.5v5.125c0,3.309-2.636,6-5.876,6s-5.875-2.691-5.875-6V11.5H7.126v5.125  c0,4.443,3.194,8.132,7.372,8.861v2.139h-3.372v3h9.749v-3h-3.376v-2.139c4.181-0.729,7.375-4.418,7.375-8.861V11.5H21.876z"/>
            </svg>
            <svg class="mute-icon icon" x="0px" y="0px" viewbox="0 0 32 32">
                <path d="M10.216,19.019C9.898,18.282,9.72,17.47,9.72,16.614v-5.125H6.721v5.125c0,1.693,0.466,3.275,1.271,4.627  L10.216,19.019z M20.47,8.765V6.364c0-2.75-2.193-5-4.875-5c-2.683,0-4.875,2.25-4.875,5v10.25c0,0.568,0.112,1.105,0.285,1.615  L20.47,8.765z M21.471,13.42v3.195c0,3.308-2.636,6-5.876,6c-0.958,0-1.861-0.24-2.661-0.657l-2.179,2.18  c0.994,0.658,2.123,1.127,3.338,1.354v2.144h-3.372v3h9.749v-3h-3.376v-2.146c4.181-0.729,7.375-4.43,7.375-8.861v-5.139h-1.067  L21.471,13.42z M20.47,16.614V14.42l-6.788,6.788c0.588,0.26,1.233,0.405,1.913,0.405C18.276,21.614,20.47,19.364,20.47,16.614z   M25.637,5.011L4.949,25.698l1.415,1.416L27.051,6.426L25.637,5.011z"/>
            </svg>
            <svg class="lock-icon icon" x="0px" y="0px" viewbox="0 0 100 100">
                <path d="M78.466,41.435h-3.21V21.018C75.256,9.428,64.15,0,50.5,0S25.744,9.428,25.744,21.018h0.001v20.417h-3.21  c-4.394,0-7.989,3.595-7.989,7.989v42.587c0,4.395,3.595,7.989,7.989,7.989h55.931c4.395,0,7.989-3.595,7.989-7.989V49.424  C86.455,45.03,82.86,41.435,78.466,41.435z M57.465,85.805H43.536l2.812-15.02c-2.337-1.41-3.905-3.968-3.905-6.896  c0-4.449,3.608-8.058,8.057-8.058c4.451,0,8.056,3.608,8.056,8.058c0,2.929-1.568,5.486-3.904,6.896L57.465,85.805z M64.646,41.435  H36.354V21.018h0c0-5.642,6.478-10.408,14.146-10.408c7.668,0,14.146,4.767,14.146,10.408V41.435z"/>
            </svg>
        </div>
        <div class="volume-pulser"></div>
    </div>
</template>
<!-- inject:js -->
<script>/**
 * Adds the MindMeldMicrophone singleton object to the global namespace. The MindMeldMicrophone
 * exposes the following methods:
 * - initialize(): sets the listener config for MM.Listener, registers click handlers, and sets up volume monitor
 * - start(): starts recording
 * - stop(): stops recording
 * - listening(): returns a boolean indicating whether the mic is listening
 * - on(event, callback, context): register for a MindMeldMicrophone event. Events exposed:
 *  - 'init': fired after initialize() finishes
 *  - 'result': there is a speech-to-text result
 *  - 'start': the microphone starts recording
 *  - 'stop': the microphone stops recording
 *  - 'error': there was an error with the microphone
 */

'use strict';
(function microphone (MM) {

    var MindMeldMicrophone = window.MindMeldMicrophone = window.MindMeldMicrophone || {};
    var containerElement;
    var listener;
    var volumeMonitor;


    // initialize() checks for speech recognition support,
    // sets up the MM.activeSession's Listener, initializes
    // the volume monitor, and initializes mindmeld-microphone's
    // click handlers
    MindMeldMicrophone.initialize = function initialize (element) {
        containerElement = element;
        if (! MM.support.speechRecognition) {
            containerElement.classList.add('disabled');
            var errorMessage = 'This browser does not support speech recognition';
            MindMeldMicrophone.publishEvent('error', errorMessage);
            return;
        }

        initMMListener();
        initVolumeMonitor();
        initClickHandlers();
        initUIHandlers();
        MindMeldMicrophone.publishEvent('init');
    };

    // Sets the listener config for a new MM.Listener The mindmeld-microphone's
    // event handlers publish the Listener events like onResult and onEnd
    function initMMListener () {
        listener = new MM.Listener({

                interimResults: true,

                onResult: function (result, resultIndex, results, event) {
                    MindMeldMicrophone.publishEvent('result', result, resultIndex, results, event);
                },

                onStart: function (event) {
                    MindMeldMicrophone.publishEvent('start', event);
                },

                onEnd: function (event) {
                    MindMeldMicrophone.publishEvent('end', event);
                },

                onError: function (error) {
                    MindMeldMicrophone.publishEvent('error', error);
                }
            }

        );
    }

    // Initializes the volume monitor used to animate the microphone
    // as the volume changes
    function initVolumeMonitor () {
        var volumePulser = containerElement.querySelector('.volume-pulser');

        volumeMonitor = new window.VolumeMonitor({
            listener: listener,

            // Animate volume pulser by scaling a background circle based on volume
            onVolumeChange: function onVolumeChanged (volume) {
                var scale = ((volume / 100) * 0.5) + 1.0;
                volumePulser.style.transform = 'scale(' + scale + ')';
            },

            // Hide volume pulser on stop
            onStop: function onVolumeMonitorStopped () {
                volumePulser.style.transform = 'scale(0.9)';
            },

            // Public microphone error event when there is a volume monitor error
            onError: function onVolumeMonitorError (error) {
                MindMeldMicrophone.publishEvent('error', error);
            }
        });
    }

    // Initializes mouse click handlers to start/stop the microphone
    function initClickHandlers () {
        var holdTimeout = null;
        var holdDuration = 1000;

        var micButton = containerElement.querySelector('.icon-container');
        micButton.addEventListener('mousedown', function onMouseDown () {
            if (listener.listening) {
                MindMeldMicrophone.stop();
            } else {
                holdTimeout = setTimeout(
                    function startContinuousOnHold () {
                        MindMeldMicrophone.start(true); // start mic in continuous mode
                        holdTimeout = null;
                    },
                    holdDuration
                )
            }
        });

        micButton.addEventListener('mouseup', function onMouseUp () {
            if (holdTimeout !== null) {
                // We have not reached the hold timeout yet, start mic in normal mode
                clearTimeout(holdTimeout);
                holdTimeout = null;
                MindMeldMicrophone.start();
            }
        });

        micButton.addEventListener('mouseout', function onMouseOut () {
            clearTimeout(holdTimeout);
            holdTimeout = null;
        });
    }

    // Subscribes to microphone start/stop events to add CSS classes
    // indicating listening, lock, or waiting state
    function initUIHandlers () {
        MindMeldMicrophone.on('start', function onMicrophoneStart () {
            containerElement.classList.add('listening');
            if (listener.continuous) {
                containerElement.classList.add('lock');
            }
        });

        MindMeldMicrophone.on('end', function onMicrophoneEnd () {
            containerElement.classList.remove('listening');
            containerElement.classList.remove('lock');
        });
    }


    // Publicly Accessible Methods of mindmeld-microphone widget

    // Start recording
    MindMeldMicrophone.start = function start (continuous) {
        listener.continuous = continuous;
        listener.start();
        volumeMonitor.start();
    };

    // Returns if the microphone is currently listening
    MindMeldMicrophone.listening = function listening () {
        return listener.listening;
    };

    // Stops recording
    MindMeldMicrophone.stop = function stop () {
        listener.stop();
    };

    // Event Dispatcher
    var subscriptions = {};

    // Subscribe to microphone events
    MindMeldMicrophone.on = function on (eventName, callback, context) {
        if (! subscriptions[eventName]) {
            subscriptions[eventName] = [];
        }
        var subscription = {
            callback: callback,
            context: context
        };
        subscriptions[eventName].push(subscription);
    };

    // Publish microphone events to subscribers
    MindMeldMicrophone.publishEvent = function publishEvent (eventName) {
        var subscribers = subscriptions[eventName];
        if (subscribers !== undefined) {
            var args = Array.prototype.slice.call(arguments, 1);
            subscribers.forEach(
                function invokeCallback (subscription) {
                    subscription.callback.apply(subscription.context, args);
                }
            )
        }
    };

}(MM));

// Volume Monitor

'use strict';
(function volumeMonitor () {

    window.navigator.getUserMedia = (window.navigator.getUserMedia ||
        window.navigator.webkitGetUserMedia ||
        window.navigator.mozGetUserMedia ||
        window.navigator.msGetUserMedia);
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var Uint8Array = window.Uint8Array;

    var VolumeMonitor = function (config) {
        this.listener = config.listener;
        this.onError = config.onError;
        this.onVolumeChange = config.onVolumeChange;
        this.onStop = config.onStop;

        this.stream = null;
        this.context = null;
        this.analyzer = null;
        this.frequencies = null;
        this.times = null;
        this.audioStarted = false;
    };

    VolumeMonitor.prototype.start = function () {
        var self = this;

        if (!this.audioStarted) {
            this.context = new AudioContext();
            this.analyzer = this.context.createAnalyser();
            this.analyzer.smoothingTimeConstant = 0.18;
            this.analyzer.fftSize = 256;

            this.frequencies = new Uint8Array(this.analyzer.frequencyBinCount);
            this.times = new Uint8Array(this.analyzer.frequencyBinCount);

            window.navigator.getUserMedia({ audio: true }, microphoneReady, function (err) {
                self.onError('The following error occurred: ' + err);
            });

            this.audioStarted = true;
        } else {
            loop();
        }


        function microphoneReady (stream) {
            self.stream = stream;
            var stream_source = self.context.createMediaStreamSource(stream);
            stream_source.connect(self.analyzer);
            loop();
        }

        function loop () {
            if (!(self.listener.pending || self.listener.listening)) {
                self.stop();
                return;
            }

            self.analyzer.getByteFrequencyData(self.frequencies);
            self.analyzer.getByteTimeDomainData(self.times);

            self.onVolumeChange && self.onVolumeChange(getVolume());

            window.setTimeout(loop, 75);
        }

        function getVolume () {
            return window.parseInt(getFrequencyRange(0, self.analyzer.frequencyBinCount - 1), 10);
        }

        function getFrequencyRange (from, to) {
            var volume = 0;

            for (var i = from; i < to; i++) {
                volume += self.frequencies[i];
            }

            return volume / ( to - from );
        }
    };

    VolumeMonitor.prototype.stop = function () {
        this.onStop && this.onStop();
        // stop recording
        this.stream && this.stream.stop();
        this.audioStarted = false;
    };

    window.VolumeMonitor = VolumeMonitor;

})();

/**
 * microphone-component.js uses MindMeldMicrophone to create a web component, <mindmeld-microphone>,
 * that wraps all the functionality in MindMeldMicrophone.
 */

'use strict';

(function microphone (MindMeldMicrophone) {
    var importerDocument = document;
    var currentScript = document._currentScript || document.currentScript;
    var componentDocument = currentScript.ownerDocument;

    var mindmeldMicrophone = Object.create(HTMLElement.prototype);
    var containerElement;

    // Called when mindmeld-microphone component is first created.
    // The created callback clones the template and creates a
    // new shadow root containing the cloned template
    mindmeldMicrophone.createdCallback = function createdCallback () {
        var template = componentDocument.querySelector('#mindmeld-microphone');
        var clone = template.content.cloneNode(true);
        var shadow = this.createShadowRoot();
        shadow.appendChild(clone);
        containerElement = shadow.querySelector('.mindmeld-microphone');
    };

    mindmeldMicrophone.initialize = function initialize () {
        MindMeldMicrophone.initialize(containerElement);
    };

    mindmeldMicrophone.start = function start (continuous) {
        MindMeldMicrophone.start(continuous);
    };

    mindmeldMicrophone.listening = function listening () {
        return MindMeldMicrophone.listening();
    };

    mindmeldMicrophone.stop = function stop () {
        MindMeldMicrophone.stop();
    };

    mindmeldMicrophone.on = function on (eventName, callback, context) {
        MindMeldMicrophone.on(eventName, callback, context);
    };


    // Register mindmeld-microphone as a web component!
    importerDocument.registerElement('mindmeld-microphone', {
        prototype: mindmeldMicrophone
    });

}(MindMeldMicrophone));</script>
<!-- endinject -->

